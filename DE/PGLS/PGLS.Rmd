---
title: "Exploring PGLS for Killifish expression"
author: "Joe McGirr"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    collapsed: no
    df_print: paged
    number_sections: yes
    theme: paper
    toc: yes
    toc_depth: 5
    toc_float: yes
  html_notebook:
    toc: yes
    toc_depth: 5
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

packages<-function(x){
  x<-as.character(match.call()[[2]])
  if (!require(x,character.only=TRUE)){
    install.packages(pkgs=x,repos="http://cran.r-project.org")
    require(x,character.only=TRUE)
  }
}

packages(MASS)
packages(ggplot2)
packages(gtools)
packages(pheatmap)
packages(cowplot)
packages(RColorBrewer)
packages(dplyr)
packages(tidyr)
packages(knitr)
packages(ggrepel)
packages(DESeq2)
packages(limma)
packages(edgeR)
packages(gplots)
packages(lattice)
packages(vsn)
packages(biomaRt)
packages(kableExtra)
packages(pheatmap)
packages(SummarizedExperiment)
packages(emmeans)
packages(data.table)
packages(ggpubr)

#install_version("ape", version = "5.3", repos = "http://cran.us.r-project.org")

library(eulerr)
library(purrr)
library(ape)
library(geiger)
library(nlme)
library(UpSetR)


# color-blind friendly 
# Wong, B. Points of view: Color blindness. Nat Methods (2011).
bla <- "#000000"
blu <- "#0072b2"
grb <- "#56b4e9"
lir <- "#cc79a7"
gre <- "#009e73"
red <- "#d55e00"
org <- "#e69f00"
yel <- "#f0e442"
gry<-  '#BBBBBB'

```

# PGLS workflow

## create log2(counts+constant) matrix (transfer)

### load transfer experiment counts with new minimum count filter

For each `condition_physiology_clade` group (regardless of species), each sample must have a minimum count of 10, and a group minimum total count of 30.

```{r, results='hide', include=FALSE, warning=FALSE, eval = FALSE}

# section 5.3 for normalizing for library size
#https://www.bioconductor.org/packages/devel/workflows/vignettes/RNAseq123/inst/doc/limmaWorkflow.html#normalising-gene-expression-distributions


#counts_design <- read.csv("https://github.com/joemcgirr/RNAseq_17killifish_osmotic/raw/main/expression_tables/Ensembl_species_counts_designfactors.csv",stringsAsFactors = FALSE)
counts_design <- read.csv("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/expression_tables/Ensembl_species_counts_designfactors.csv",stringsAsFactors = FALSE)


# I removed the same samples from species with low numbers of replicates (*F. zebrinus*, *F. nottii*, *F. sciadicus*).  


#length(counts_design)
samps <- as.data.frame(colnames(counts_design)[3:length(counts_design)])
samps <- samps %>% separate(`colnames(counts_design)[3:length(counts_design)]`, , into = c("species", "genus", "treatment","replicate"), sep = "_")
samps$group <- paste(samps$species,samps$genus,samps$treatment, sep = ":")
#table(samps$group)
#length(unique(paste(samps$species,samps$genus)))

samps_t <- samps %>% filter(treatment == "transfer")
samps_b <- samps %>% filter(treatment == "BW")
samps_f <- samps %>% filter(treatment == "FW")

design <- counts_design[counts_design$Ensembl == 'Empty',]


#choose experiment

# -----------------------
# transfer experiment
# -----------------------

# dropping all zebrinus, nottii, sciadicus, due to sample size
# drops <- c("X","Ensembl",
#            "F_zebrinus_BW_1.quant","F_zebrinus_BW_2.quant",
#            "F_zebrinus_FW_1.quant","F_zebrinus_FW_2.quant",
#            "F_nottii_FW_1.quant","F_nottii_FW_2.quant",
#            "F_sciadicus_BW_1.quant","F_sciadicus_FW_1.quant",
#            "F_sciadicus_FW_2.quant","F_sciadicus_transfer_1.quant")
# 
# bw_drops <- grep('_BW_', colnames(counts_design), value=TRUE)
# 
# counts<-counts_design[!counts_design$Ensembl == 'Empty',]
# rownames(counts)<-counts$Ensembl
# design <- design[ , !(names(design) %in% drops)]
# counts <- counts[ , !(names(counts) %in% drops)]
# design <- design[ , !(names(design) %in% bw_drops)]
# counts <- counts[ , !(names(counts) %in% bw_drops)]



# -----------------------
# acclimation experiment
# -----------------------

drops <- c("X","Ensembl",
           "F_zebrinus_BW_1.quant","F_zebrinus_BW_2.quant",
           "F_zebrinus_FW_1.quant","F_zebrinus_FW_2.quant",
           "F_nottii_FW_1.quant","F_nottii_FW_2.quant",
           "F_sciadicus_BW_1.quant","F_sciadicus_FW_1.quant","F_sciadicus_FW_2.quant")

transfer_drops <- c("F_sciadicus_transfer_1.quant","F_rathbuni_transfer_1.quant","F_rathbuni_transfer_2.quant","F_rathbuni_transfer_3.quant",
                     "F_grandis_transfer_1.quant","F_grandis_transfer_2.quant","F_grandis_transfer_3.quant",
                     "F_notatus_transfer_1.quant","F_notatus_transfer_2.quant","F_notatus_transfer_3.quant",
                     "F_parvapinis_transfer_1.quant","F_parvapinis_transfer_2.quant",
                     "L_goodei_transfer_1.quant","L_goodei_transfer_2.quant","L_goodei_transfer_3.quant",
                     "F_olivaceous_transfer_1.quant","F_olivaceous_transfer_2.quant",
                     "L_parva_transfer_1.quant","L_parva_transfer_2.quant","L_parva_transfer_3.quant",
                     "F_heteroclitusMDPP_transfer_1.quant","F_heteroclitusMDPP_transfer_2.quant","F_heteroclitusMDPP_transfer_3.quant",
                     "F_similis_transfer_1.quant","F_similis_transfer_2.quant","F_similis_transfer_3.quant",
                     "F_diaphanus_transfer_1.quant","F_diaphanus_transfer_2.quant",
                     "F_chrysotus_transfer_1.quant","F_chrysotus_transfer_2.quant",
                     "A_xenica_transfer_1.quant","A_xenica_transfer_2.quant","A_xenica_transfer_3.quant" ,
                     "F_catanatus_transfer_1.quant","F_catanatus_transfer_2.quant",
                     "F_heteroclitusMDPL_transfer_1.quant","F_heteroclitusMDPL_transfer_2.quant","F_heteroclitusMDPL_transfer_3.quant")
counts<-counts_design[!counts_design$Ensembl == 'Empty',]
rownames(counts)<-counts$Ensembl
design <- design[ , !(names(design) %in% drops)]
counts <- counts[ , !(names(counts) %in% drops)]
design <- design[ , !(names(design) %in% transfer_drops)]
counts <- counts[ , !(names(counts) %in% transfer_drops)]




# continue

gene.names<-rownames(counts)
design[] <- lapply( design, factor)

species<-as.character(unlist(design[1,]))
physiology<-as.character(unlist(design[2,]))
clade<-as.character(unlist(design[3,]))
condition<-as.character(unlist(design[5,]))
condition_physiology<-as.vector(paste(condition,physiology,sep="."))
condition_physiology_clade <- as.vector(paste(condition_physiology,clade,sep="."))
condition_physiology_clade <- as.vector(paste("group",condition_physiology_clade,sep=""))
cols<-colnames(counts)
ExpDesign <- data.frame(row.names=cols,
                        condition=condition,
                        physiology = physiology,
                        clade = clade,
                        species = species,
                        sample=cols)
#ExpDesign
# used for pairwise contrasts
#form<-as.formula("~0 + physiology*condition*clade")
form<-as.formula("~physiology*condition*clade")
design = model.matrix(form, ExpDesign)
#group <- interaction(physiology, condition, clade)
#mm <- model.matrix(~0 + group)
#colnames(design)
# check rank of matrix
#Matrix::rankMatrix( design )
#dim(design)
clade <- ExpDesign$clade
physiology <- ExpDesign$physiology

#write.table(ExpDesign,"C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/ExpDesign.txt",sep="\t",quote=FALSE, row.names = FALSE)


## Filtering and Normalization


#Genes with low expression across samples were dropped from the analysis using a conservative approach. The function `filterByExpr` was used on the raw counts matrix. For each `condition_physiology` group (regardless of species), each sample must have a minium count of 10, and a group minimum total count of 100. This reduced the counts table to the following dimensions (genes x samples):

counts<-as.matrix(as.data.frame(sapply(counts, as.numeric)))
rownames(counts)<-gene.names
#class(counts)
#test<-counts %>% drop_na()
#test<-as.matrix(test)
lcom_unfilt<-log2(counts+1)
#plot(colSums(t(lcom_unfilt)))

#lisa's minimun count filter
#keep<-filterByExpr(counts,design = design,group=condition_physiology,min.count = 10, min.total.count = 100)
#joe's minimum count filter
keep<-filterByExpr(counts,design = design,group=condition_physiology_clade,min.count = 10, min.total.count = 30)
counts.filt <- counts[keep,]
#print("filtered_counts")
dim(counts.filt)
#write.table(counts.filt,"C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/DE_limma_FW_v_transfer/exp.tsv",sep="\t",quote=FALSE)



## biomaRt annotation

# ============================================
# biomart annotation
# https://uswest.ensembl.org/Fundulus_heteroclitus/Info/Index
# ============================================

ensembl=useMart("ENSEMBL_MART_ENSEMBL")
ensembl = useDataset("fheteroclitus_gene_ensembl",mart=ensembl)
# test
# id <- c("ENSGMOP00000000001.1","ENSGMOP00000000002.1","ENSGMOP00000000003.1")
ensembl_proteinID <- rownames(counts)
ensembl_proteinID <- unlist(strsplit(ensembl_proteinID,split="[.]1"))

#length(ensembl_proteinID)
# can take >5 min
# do only once
ann<-getBM(attributes=c('ensembl_peptide_id','ensembl_transcript_id','ensembl_gene_id','gene_biotype','external_gene_name','description'), filters = 'ensembl_peptide_id', values = ensembl_proteinID, mart=ensembl)
#head(ann)
#dim(ann)
#length(unique(ann$ensembl_peptide_id))
ann <- ann[!duplicated(ann[,c(1)]),]
#dim(ann)
#write.table(ann,"C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/DE_limma_FW_v_transfer/annotations.tsv",sep="\t",quote=FALSE)

#print("log counts before DE")
#boxplot(log(counts.filt+1), las = 2, main = "")

genes = DGEList(count = counts.filt, group = condition_physiology_clade)
genes = calcNormFactors(genes)

#head(genes)

# counts per million normalized by library size from genes$samples$norm.factors
cpm <- cpm(genes$counts, log = FALSE,normalized.lib.sizes = TRUE)

lib_norm_counts <- cpm
#lib_norm_counts$Ensembl <- NULL

#head(lib_norm_counts)

# CHOOSE Experiment
meta <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/ExpDesign_FW_v_BW.txt",stringsAsFactors = FALSE, header = TRUE)
rownames(meta) <- meta$sample
meta <- meta[,-5]
meta$physiology <- gsub('M', 'euryhaline', meta$physiology)
meta$physiology <- gsub('FW', 'stenohaline', meta$physiology)
meta$clade <- gsub('Clade1', 'clade 1', meta$clade)
meta$clade <- gsub('Clade2', 'clade 2', meta$clade)
meta$clade <- gsub('Clade3', 'clade 3', meta$clade)




```

### determine appropriate constant

```{r, results = 'hide', eval = FALSE}


js <- c(1,2,5,10)
js <- c(0.001,0.01,0.1,0.5)
js <- seq(from = 0.399921, to = 0.4001, by = 0.00001)

#best for transfer
#js <- c(0.35243)
#best for acclimation
#js <- c(0.39992)

slopes <- c()

for (j in js){
#Transform count + constant:
constant <- j
trans <- log2(lib_norm_counts+constant)

mean_counts <- colMeans(trans)
norm_counts <- sweep(trans, 2, colMeans(trans), "-")
grandmean <- mean(mean_counts)
norm_counts <- norm_counts + grandmean
#head(norm_counts)
#range(norm_counts)


ttrans <- t(head(norm_counts))
ttrans <- t(norm_counts)
ttrans <- as.data.frame(ttrans)


	genelist <- colnames(ttrans)
	ttrans$trt <- meta$condition
	treat <- unique(ttrans$trt)

	#adjusting fun_MeanVar_all.R
	
	meandat <- matrix(nrow=length(treat), ncol=length(genelist))
	colnames(meandat) <- genelist
	rownames(meandat) <- treat 
	for (i in 1:length(treat)) {
		a <- which(ttrans$trt == treat[i])
		n <- apply(ttrans[a,1:(dim(ttrans)[2]-1)], 2, mean)
		b <- which(rownames(meandat)==treat[i])
		meandat[b,] <- n 
		}
	
	# swap this for sd instead of variance
	
	# vardat <- matrix(nrow=length(treat), ncol=length(genelist))
	# colnames(vardat) <- genelist
	# rownames(vardat) <- treat 
	# for (i in 1:length(treat)) {
	# 	if (length(which(ttrans$trt==treat[i])) > 1) {
	# 		a <- which(ttrans$trt==treat[i])
	# 		#print(a)
	# 		n <- apply(ttrans[a,1:(dim(ttrans)[2]-1)], 2, sd, na.rm=TRUE)
	# 		#print(n)
	# 		b <- which(rownames(vardat)==treat[i])
	# 		#print(b)
	# 		vardat[b,] <- n 
	# 		}
	
	vardat <- matrix(nrow=length(treat), ncol=length(genelist))
	colnames(vardat) <- genelist
	rownames(vardat) <- treat 
	for (i in 1:length(treat)) {
		if (length(which(ttrans$trt==treat[i])) > 1) {
			a <- which(ttrans$trt==treat[i])
			#print(a)
			n <- apply(ttrans[a,1:(dim(ttrans)[2]-1)], 2, var, na.rm=TRUE)
			#print(n)
			b <- which(rownames(vardat)==treat[i])
			#print(b)
			vardat[b,] <- n 
			}
	}
	mv <- list(mean=meandat, stdev=vardat)

#head(meanvar)
#dim(meanvar)

#mv <- MeanVar(ttrans)
mea <- as.vector(mv$mean)
sd <- as.vector(mv$stdev)
slope <- (coef(lm(sd~mea))[2])
#print(slope)
slopes <- c(slopes, slope[[1]])
}
#slopes
df <- data.frame(slopes,js)
#df
df[which(abs(df$slopes) == min(abs(df$slopes))),]

#best for transfer
constant <- 0.35243
# slope = -1.273828e-06
#best for acclimation
constant <- 0.39992
# slope -1.838383e-06

trans <- log2(lib_norm_counts+constant)
head(trans)
#write.table(trans, "C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_acclimation_constant0.39992.txt")



```

### Visualize mean-standard deviation relationship after normalization: 

```{r}
constant <- 0.39992


meta <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/ExpDesign_FW_v_transfer.txt",stringsAsFactors = FALSE, header = TRUE)
meta <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/ExpDesign_FW_v_BW.txt",stringsAsFactors = FALSE, header = TRUE)

rownames(meta) <- meta$sample
meta <- meta[,-5]
meta$physiology <- gsub('M', 'euryhaline', meta$physiology)
meta$physiology <- gsub('FW', 'stenohaline', meta$physiology)
meta$clade <- gsub('Clade1', 'clade 1', meta$clade)
meta$clade <- gsub('Clade2', 'clade 2', meta$clade)
meta$clade <- gsub('Clade3', 'clade 3', meta$clade)
names(meta)[names(meta) == "species"] <- "Species"
# fix names to match tree
meta$Species <- gsub("A_xenica","F_xenicus",meta$Species)
meta$Species <- gsub("F_parvapinis","F_parvipinnis",meta$Species)
meta$Species <- gsub("F_catanatus","F_catenatus",meta$Species)
meta$Species <- gsub("F_olivaceous","F_olivaceus",meta$Species)


trans<- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_acclimation_constant0.39992.txt", stringsAsFactors = FALSE)


mean_counts <- colMeans(trans)
norm_counts <- sweep(trans, 2, colMeans(trans), "-")
grandmean <- mean(mean_counts)
norm_counts <- norm_counts + grandmean
#head(norm_counts)
#range(norm_counts)


ttrans <- t(head(norm_counts))
ttrans <- t(norm_counts)
ttrans <- as.data.frame(ttrans)


	genelist <- colnames(ttrans)
	ttrans$trt <- meta$condition
	treat <- unique(ttrans$trt)

	#adjusting fun_MeanVar_all.R
	
	meandat <- matrix(nrow=length(treat), ncol=length(genelist))
	colnames(meandat) <- genelist
	rownames(meandat) <- treat 
	for (i in 1:length(treat)) {
		a <- which(ttrans$trt == treat[i])
		n <- apply(ttrans[a,1:(dim(ttrans)[2]-1)], 2, mean)
		b <- which(rownames(meandat)==treat[i])
		meandat[b,] <- n 
		}
	
	# swap this for sd instead of variance
	
	# vardat <- matrix(nrow=length(treat), ncol=length(genelist))
	# colnames(vardat) <- genelist
	# rownames(vardat) <- treat 
	# for (i in 1:length(treat)) {
	# 	if (length(which(ttrans$trt==treat[i])) > 1) {
	# 		a <- which(ttrans$trt==treat[i])
	# 		#print(a)
	# 		n <- apply(ttrans[a,1:(dim(ttrans)[2]-1)], 2, sd, na.rm=TRUE)
	# 		#print(n)
	# 		b <- which(rownames(vardat)==treat[i])
	# 		#print(b)
	# 		vardat[b,] <- n 
	# 		}
	
	vardat <- matrix(nrow=length(treat), ncol=length(genelist))
	colnames(vardat) <- genelist
	rownames(vardat) <- treat 
	for (i in 1:length(treat)) {
		if (length(which(ttrans$trt==treat[i])) > 1) {
			a <- which(ttrans$trt==treat[i])
			#print(a)
			n <- apply(ttrans[a,1:(dim(ttrans)[2]-1)], 2, var, na.rm=TRUE)
			#print(n)
			b <- which(rownames(vardat)==treat[i])
			#print(b)
			vardat[b,] <- n 
			}
	}
	mv <- list(mean=meandat, stdev=vardat)


#mv <- MeanVar(ttrans)
mea <- as.vector(mv$mean)
sd <- as.vector(mv$stdev)
slope <- (coef(lm(sd~mea))[2])


#png("C:/Users/jmcgirr/Documents/Whitehead_Lab/fun/figs/pgls/mean_var_acclimation.png",height = 4.5, width = 7, units = 'in', res = 600)
plot(mea,sd,xlab = "mean",ylab = "variance", pch=16, cex=0.5,cex.main=.8, main=paste("Mean-Var relationship of Normalized Log(counts + ",constant,"), slope=",round(slope,4),sep = ""))
abline(coef(lm(sd~mea)),col="red",lwd=3)
lines(lowess(mea,sd,f=0.2),col="blue",lwd=3)
#dev.off()




```

# PGLS

## physiology

gls(counts~physiology)

In order to have 1:1 mapping species:tree_tip, I test FW_acclimation,BW_acclimation, and transfer separately. Counts are averaged across replicates. Genes showing significant DE between euryhaline and stenohaline groups after accounting for branch lengths in all three tests are shown in overlap with limma approach (significant physiology main effect).

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

full_tree <- read.tree("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/fundulus_rodgers_2018.nwk")

limma_genes_FW_transfer <- read.csv("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/DE_limma_FW_v_transfer/DE_results/main_physiology.csv", stringsAsFactors = FALSE)
limma_genes_FW_BW <- read.csv("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/DE_limma_FW_v_BW/DE_results/main_physiology.csv", stringsAsFactors = FALSE)
limma_sig_FW_transfer <- limma_genes_FW_transfer[limma_genes_FW_transfer$adj.P.Val < 0.05,]
limma_sig_FW_BW <- limma_genes_FW_BW[limma_genes_FW_BW$adj.P.Val < 0.05,]

####  choose gene to test
# cftr (significant for transfer/acclimation)
#gene <- c("ENSFHEP00000008393")
# significant for physiology (Lisa Fig 11)
#gene <- c("ENSFHEP00000001090")
#gene_name <- "slc35a3a"
# top significant for physiology 
#gene <- c("ENSFHEP00000019927")
#gene_name <- "kdm5c"

```

### FW (using FW vs. transfer normalized counts)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

meta <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/ExpDesign_FW_v_transfer.txt",stringsAsFactors = FALSE, header = TRUE)

rownames(meta) <- meta$sample
meta <- meta[,-5]
meta$physiology <- gsub('M', 'euryhaline', meta$physiology)
meta$physiology <- gsub('FW', 'stenohaline', meta$physiology)
meta$clade <- gsub('Clade1', 'clade 1', meta$clade)
meta$clade <- gsub('Clade2', 'clade 2', meta$clade)
meta$clade <- gsub('Clade3', 'clade 3', meta$clade)
names(meta)[names(meta) == "species"] <- "Species"
# fix names to match tree
meta$Species <- gsub("A_xenica","F_xenicus",meta$Species)
meta$Species <- gsub("F_parvapinis","F_parvipinnis",meta$Species)
meta$Species <- gsub("F_catanatus","F_catenatus",meta$Species)
meta$Species <- gsub("F_olivaceous","F_olivaceus",meta$Species)
# combine heteroclitus subpopulations
meta$Species <- gsub("F_heteroclitusMDPP","F_heteroclitus",meta$Species)
meta$Species <- gsub("F_heteroclitusMDPL","F_heteroclitus",meta$Species)


cts <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_transfer_constant0.35243.txt", stringsAsFactors = FALSE)
#cts <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_acclimation_constant0.39992.txt", stringsAsFactors = FALSE)
row.names(cts) <- gsub("\\..*","",row.names(cts))

keeps <- grep('_FW_', colnames(cts), value=TRUE)
cts_condition <- cts[ , (names(cts) %in% keeps)]

test_genes <- limma_genes_FW_transfer$X
#test_gene <- limma_genes$X[3]
#test_gene <- "ENSFHEP00000018189"
p_vals <- c()

for (test_gene in test_genes){
 

# run PGLS 
gene_ct <- t(subset(cts_condition, rownames(cts_condition) == test_gene))
gene_ct <- merge(gene_ct,meta, by = 0)
sp_means <- aggregate(gene_ct[,2], list(gene_ct$Species), mean)
sp_means$tree_tip <- sp_means$Group.1
row.names(sp_means) <- sp_means$tree_tip
sp_means$Group.1 <- NULL
names(sp_means) <- c("normalized_count", "Species")
sp_means <- unique(merge(sp_means, meta[,2:4], by = c("Species")))
row.names(sp_means) <- sp_means$Species
tree<-drop.tip(full_tree, setdiff(full_tree$tip.label,sp_means$Species))
  # make sure all counts !=0
  if (length(unique(sp_means$normalized_count))<2){
  p_vals <- c(p_vals,999)  
  } else {

pglsModel <- gls(normalized_count ~ physiology, correlation = corBrownian(phy = tree),
    data = sp_means, method = "ML")
an <- anova(pglsModel)
p_vals <- c(p_vals,an$`p-value`[2])

#boxplot(gene_ct[,2]~gene_ct$physiology, ylab = "normalized count", xlab = "", main = gene_name)

}
}

pgls_res_FW_transfer <- data.frame(gene = test_genes,p = p_vals)
pgls_sig_FW_transfer <- pgls_res_FW_transfer[pgls_res_FW_transfer$p < 0.05,]

plot(euler(list(limma_sig=limma_sig_FW_transfer$X,
                pgls_sig_FW_transfer=pgls_sig_FW_transfer$gene)),quantities = TRUE, labels = c("",""))
```

### transfer

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

keeps <- grep('_transfer_', colnames(cts), value=TRUE)
cts_condition <- cts[ , (names(cts) %in% keeps)]

test_genes <- limma_genes_FW_transfer$X
p_vals <- c()

for (test_gene in test_genes){
 

# run PGLS 
gene_ct <- t(subset(cts_condition, rownames(cts_condition) == test_gene))
gene_ct <- merge(gene_ct,meta, by = 0)
sp_means <- aggregate(gene_ct[,2], list(gene_ct$Species), mean)
sp_means$tree_tip <- sp_means$Group.1
row.names(sp_means) <- sp_means$tree_tip
sp_means$Group.1 <- NULL
names(sp_means) <- c("normalized_count", "Species")
sp_means <- unique(merge(sp_means, meta[,2:4], by = c("Species")))
row.names(sp_means) <- sp_means$Species
tree<-drop.tip(full_tree, setdiff(full_tree$tip.label,sp_means$Species))
  # make sure all counts !=0
  if (length(unique(sp_means$normalized_count))<2){
  p_vals <- c(p_vals,999)  
  } else {

pglsModel <- gls(normalized_count ~ physiology, correlation = corBrownian(phy = tree),
    data = sp_means, method = "ML")
an <- anova(pglsModel)
p_vals <- c(p_vals,an$`p-value`[2])

#boxplot(gene_ct[,2]~gene_ct$physiology, ylab = "normalized count", xlab = "", main = gene_name)

}
}

pgls_res_transfer <- data.frame(gene = test_genes,p = p_vals)
pgls_sig_transfer <- pgls_res_transfer[pgls_res_transfer$p < 0.05,]

plot(euler(list(limma_sig=limma_sig_FW_transfer$X,
                pgls_sig_transfer=pgls_sig_transfer$gene)),quantities = TRUE, labels = c("",""))


```

### FW (using FW vs. BW normalized counts)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

meta <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/ExpDesign_FW_v_BW.txt",stringsAsFactors = FALSE, header = TRUE)

rownames(meta) <- meta$sample
meta <- meta[,-5]
meta$physiology <- gsub('M', 'euryhaline', meta$physiology)
meta$physiology <- gsub('FW', 'stenohaline', meta$physiology)
meta$clade <- gsub('Clade1', 'clade 1', meta$clade)
meta$clade <- gsub('Clade2', 'clade 2', meta$clade)
meta$clade <- gsub('Clade3', 'clade 3', meta$clade)
names(meta)[names(meta) == "species"] <- "Species"
# fix names to match tree
meta$Species <- gsub("A_xenica","F_xenicus",meta$Species)
meta$Species <- gsub("F_parvapinis","F_parvipinnis",meta$Species)
meta$Species <- gsub("F_catanatus","F_catenatus",meta$Species)
meta$Species <- gsub("F_olivaceous","F_olivaceus",meta$Species)
# combine heteroclitus subpopulations
meta$Species <- gsub("F_heteroclitusMDPP","F_heteroclitus",meta$Species)
meta$Species <- gsub("F_heteroclitusMDPL","F_heteroclitus",meta$Species)

#cts <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_transfer_constant0.35243.txt", stringsAsFactors = FALSE)
cts <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_acclimation_constant0.39992.txt", stringsAsFactors = FALSE)
row.names(cts) <- gsub("\\..*","",row.names(cts))

keeps <- grep('_FW_', colnames(cts), value=TRUE)
cts_condition <- cts[ , (names(cts) %in% keeps)]

test_genes <- limma_genes_FW_BW$X
p_vals <- c()

for (test_gene in test_genes){
 

# run PGLS 
gene_ct <- t(subset(cts_condition, rownames(cts_condition) == test_gene))
gene_ct <- merge(gene_ct,meta, by = 0)
sp_means <- aggregate(gene_ct[,2], list(gene_ct$Species), mean)
sp_means$tree_tip <- sp_means$Group.1
row.names(sp_means) <- sp_means$tree_tip
sp_means$Group.1 <- NULL
names(sp_means) <- c("normalized_count", "Species")
sp_means <- unique(merge(sp_means, meta[,2:4], by = c("Species")))
row.names(sp_means) <- sp_means$Species
tree<-drop.tip(full_tree, setdiff(full_tree$tip.label,sp_means$Species))
  # make sure all counts !=0
  if (length(unique(sp_means$normalized_count))<2){
  p_vals <- c(p_vals,999)  
  } else {

pglsModel <- gls(normalized_count ~ physiology, correlation = corBrownian(phy = tree),
    data = sp_means, method = "ML")
an <- anova(pglsModel)
p_vals <- c(p_vals,an$`p-value`[2])

#boxplot(gene_ct[,2]~gene_ct$physiology, ylab = "normalized count", xlab = "", main = gene_name)

}
}

pgls_res_FW_BW <- data.frame(gene = test_genes,p = p_vals)
pgls_sig_FW_BW <- pgls_res_FW_BW[pgls_res_FW_BW$p < 0.05,]

plot(euler(list(limma_sig=limma_sig_FW_BW$X,
                pgls_sig_FW_BW=pgls_sig_FW_BW$gene)),quantities = TRUE, labels = c("",""))
```

### BW

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

keeps <- grep('_BW_', colnames(cts), value=TRUE)
cts_condition <- cts[ , (names(cts) %in% keeps)]

test_genes <- limma_genes_FW_BW$X
p_vals <- c()

for (test_gene in test_genes){
 

# run PGLS 
gene_ct <- t(subset(cts_condition, rownames(cts_condition) == test_gene))
gene_ct <- merge(gene_ct,meta, by = 0)
sp_means <- aggregate(gene_ct[,2], list(gene_ct$Species), mean)
sp_means$tree_tip <- sp_means$Group.1
row.names(sp_means) <- sp_means$tree_tip
sp_means$Group.1 <- NULL
names(sp_means) <- c("normalized_count", "Species")
sp_means <- unique(merge(sp_means, meta[,2:4], by = c("Species")))
row.names(sp_means) <- sp_means$Species
tree<-drop.tip(full_tree, setdiff(full_tree$tip.label,sp_means$Species))
  # make sure all counts !=0
  if (length(unique(sp_means$normalized_count))<2){
  p_vals <- c(p_vals,999)  
  } else {

pglsModel <- gls(normalized_count ~ physiology, correlation = corBrownian(phy = tree),
    data = sp_means, method = "ML")
an <- anova(pglsModel)
p_vals <- c(p_vals,an$`p-value`[2])

#boxplot(gene_ct[,2]~gene_ct$physiology, ylab = "normalized count", xlab = "", main = gene_name)

}
}

pgls_res_BW <- data.frame(gene = test_genes,p = p_vals)
pgls_sig_BW <- pgls_res_BW[pgls_res_BW$p < 0.05,]

plot(euler(list(limma_sig=limma_sig_FW_BW$X,
                pgls_sig_BW=pgls_sig_BW$gene)),quantities = TRUE, labels = c("",""))



```

### all physiology UPSET

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}


listInput <- list(limma_sig_FW_BW=limma_sig_FW_BW$X,
                  limma_sig_FW_transfer=limma_sig_FW_transfer$X,
                  pgls_sig_FW_BW=pgls_sig_FW_BW$gene,
                  pgls_sig_FW_transfer=pgls_sig_FW_transfer$gene,
                  pgls_sig_BW=pgls_sig_BW$gene,
                  pgls_sig_transfer=pgls_sig_transfer$gene)
names(listInput) <- c("limma acclimation", 
                      "limma transfer",
                      "PGLS FW BW",
                      "PGLS FW transfer",
                      "PGLS BW",
                      "PGLS transfer")

#png("C:/Users/jmcgirr/Documents/" , width = 12, height = 7, units = 'in', res = 600)
upset(fromList(listInput), sets = rev(names(listInput)),order.by = "freq", 
      point.size = 3.4, line.size = 1.2, 
      mainbar.y.label = "genes intersecting", sets.x.label = "genes")
      #nsets = 6,text.scale = c(2, 1.6, 1.5, 1.4, 2,1.6),keep.order = TRUE)
#dev.off()

#write.table(pgls_res,"C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/results/FW_main_physiology.txt",sep="\t",quote=FALSE, row.names = FALSE)

```

## condition x physiology
In order to have 1:1 mapping species:tree_tip, I use slopes between means (the response to condition) to compare expression in a species between conditions.

gls(slope~physiology)

### transfer experiment 
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

meta <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/ExpDesign_FW_v_transfer.txt",stringsAsFactors = FALSE, header = TRUE)
rownames(meta) <- meta$sample
meta <- meta[,-5]
meta$physiology <- gsub('M', 'euryhaline', meta$physiology)
meta$physiology <- gsub('FW', 'stenohaline', meta$physiology)
meta$clade <- gsub('Clade1', 'clade 1', meta$clade)
meta$clade <- gsub('Clade2', 'clade 2', meta$clade)
meta$clade <- gsub('Clade3', 'clade 3', meta$clade)
names(meta)[names(meta) == "species"] <- "Species"
# fix names to match tree
meta$Species <- gsub("A_xenica","F_xenicus",meta$Species)
meta$Species <- gsub("F_parvapinis","F_parvipinnis",meta$Species)
meta$Species <- gsub("F_catanatus","F_catenatus",meta$Species)
meta$Species <- gsub("F_olivaceous","F_olivaceus",meta$Species)
# combine heteroclitus subpopulations
meta$Species <- gsub("F_heteroclitusMDPP","F_heteroclitus",meta$Species)
meta$Species <- gsub("F_heteroclitusMDPL","F_heteroclitus",meta$Species)


####  choose gene to test
# significant for transfer/acclimation
#gene <- c("ENSFHEP00000008393")
#gene_name <- c("cftr")
# significant for physiology (Lisa Fig 11)
#gene <- c("ENSFHEP00000001090")
#gene_name <- "slc35a3a"
# top significant for transfer
#gene <- c("ENSFHEP00000031307")
#gene_name <- "bcl6ab"
# top significant for physiology 
#gene <- c("ENSFHEP00000019927")
#gene_name <- "kdm5c"
# top transfer x physiology 
#gene <- c("ENSFHEP00000010294")
#gene_name <- "C11orf98"

cts <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_transfer_constant0.35243.txt", stringsAsFactors = FALSE)
row.names(cts) <- gsub("\\..*","",row.names(cts))
full_tree <- read.tree("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/fundulus_rodgers_2018.nwk")
limma_genes <- read.csv("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/DE_limma_FW_v_transfer/DE_results/transfer_physiology_interaction.csv", stringsAsFactors = FALSE)

test_genes <- limma_genes$X
test_gene <- limma_genes$X[2]
p_vals <- c()

for (test_gene in test_genes){
  
gene_ct <- t(subset(cts, rownames(cts) == test_gene))

gene_ct <- merge(gene_ct,meta, by = 0)
gene_ct$Species_condition <- paste(gene_ct$Species, gene_ct$condition, sep = ":")
colnames(gene_ct)[2] <- "gene"
slopes <- gene_ct %>%
  group_by(Species) %>% 
  do(mod_lin = lm(gene~condition, data = .)) %>% 
  mutate(intercept = mod_lin$coefficients[1],
         slope = mod_lin$coefficients[2]) %>% as.data.frame()
slopes <- slopes[c("Species","slope")]
slopes <- unique(merge(slopes, meta[,2:4], by = c("Species")))
row.names(slopes) <- slopes$Species

tree<-drop.tip(full_tree, setdiff(full_tree$tip.label,slopes$Species))


pglsModel <- gls(slope ~ physiology, correlation = corBrownian(phy = tree),
    data = slopes, method = "ML")
an <- anova(pglsModel)
p_vals <- c(p_vals,an$`p-value`[2])

#boxplot(gene_ct[,2]~gene_ct$physiology, ylab = "normalized count", xlab = "", main = gene_name)
#boxplot(gene_ct[,2]~gene_ct$condition, ylab = "normalized count", xlab = "", main = gene_name)
#boxplot(slopes$slope~slopes$physiology, ylab = "slope", xlab = "", main = gene_name)


# gene_ct$Species <- factor(gene_ct$Species,levels = c("F_catenatus","F_rathbuni","F_diaphanus","F_grandis","L_goodei","F_parvipinnis","L_parva","F_notatus","F_olivaceus","F_xenicus","F_chrysotus","F_similis"),ordered = TRUE)
# p1<-ggplot(gene_ct, aes(x=condition, y=gene, col = Species, fill = physiology)) +
#  geom_point()+
#    theme_minimal()+
#    ylab("log2 normalized counts\n")+
#    xlab("\ncondition")+
#    scale_fill_manual(values=c(blu,red))+
#    scale_color_manual(values = c(rep("black",28)))+
#    #ggtitle(paste(gene_name,"\n", sig_genes[1,1], sep = ""))+
#    facet_wrap(~clade + Species, ncol = 14)+
#    stat_summary(geom = "point",fun = "mean",size = 3,shape = 22,aes(fill =physiology))+
#    stat_summary(geom = "line",fun = "mean",col = "black",aes(group = 1))+
#    theme(axis.text.x = element_text(angle=90, hjust=1))+
#    theme(strip.text.x = element_text(size = 6))+
#    theme(legend.position = "none")

#png(paste("C:/Users/jmcgirr/Documents/Whitehead_Lab/fun/figs/genes/",gene_name, "_",comp,"_exp_transfer.png",sep = ""), height = 4.5, width = 12, units = 'in', res = 600)
#print(p1)
#dev.off()
}

pgls_res <- data.frame(gene = test_genes,p = p_vals)
pgls_sig <- pgls_res[pgls_res$p < 0.05,]
limma_sig <- limma_genes[limma_genes$adj.P.Val < 0.05,]



plot(euler(list(limma_sig=limma_sig$X,
                pgls_sig=pgls_sig$gene)),quantities = TRUE, labels = c("",""))

#write.table(pgls_res,"C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/results/transfer_physiology_interaction.txt",sep="\t",quote=FALSE, row.names = FALSE)

```

### acclimation experiment 
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 7}

meta <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/ExpDesign_FW_v_BW.txt",stringsAsFactors = FALSE, header = TRUE)
rownames(meta) <- meta$sample
meta <- meta[,-5]
meta$physiology <- gsub('M', 'euryhaline', meta$physiology)
meta$physiology <- gsub('FW', 'stenohaline', meta$physiology)
meta$clade <- gsub('Clade1', 'clade 1', meta$clade)
meta$clade <- gsub('Clade2', 'clade 2', meta$clade)
meta$clade <- gsub('Clade3', 'clade 3', meta$clade)
names(meta)[names(meta) == "species"] <- "Species"
# fix names to match tree
meta$Species <- gsub("A_xenica","F_xenicus",meta$Species)
meta$Species <- gsub("F_parvapinis","F_parvipinnis",meta$Species)
meta$Species <- gsub("F_catanatus","F_catenatus",meta$Species)
meta$Species <- gsub("F_olivaceous","F_olivaceus",meta$Species)
# combine heteroclitus subpopulations
meta$Species <- gsub("F_heteroclitusMDPP","F_heteroclitus",meta$Species)
meta$Species <- gsub("F_heteroclitusMDPL","F_heteroclitus",meta$Species)


cts <- read.table("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/normalized_cts_acclimation_constant0.39992.txt", stringsAsFactors = FALSE)
row.names(cts) <- gsub("\\..*","",row.names(cts))
full_tree <- read.tree("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/fundulus_rodgers_2018.nwk")
limma_genes <- read.csv("C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/counts_threshold_new/DE_limma_FW_v_BW/DE_results/salinity_physiology_interaction.csv", stringsAsFactors = FALSE)

test_genes <- limma_genes$X
test_gene <- limma_genes$X[2]
p_vals <- c()

for (test_gene in test_genes){
  
gene_ct <- t(subset(cts, rownames(cts) == test_gene))

gene_ct <- merge(gene_ct,meta, by = 0)
gene_ct$Species_condition <- paste(gene_ct$Species, gene_ct$condition, sep = ":")
colnames(gene_ct)[2] <- "gene"
slopes <- gene_ct %>%
  group_by(Species) %>% 
  do(mod_lin = lm(gene~condition, data = .)) %>% 
  mutate(intercept = mod_lin$coefficients[1],
         slope = mod_lin$coefficients[2]) %>% as.data.frame()
slopes <- slopes[c("Species","slope")]
slopes <- unique(merge(slopes, meta[,2:4], by = c("Species")))
row.names(slopes) <- slopes$Species

tree<-drop.tip(full_tree, setdiff(full_tree$tip.label,slopes$Species))


pglsModel <- gls(slope ~ physiology, correlation = corBrownian(phy = tree),
    data = slopes, method = "ML")
an <- anova(pglsModel)
p_vals <- c(p_vals,an$`p-value`[2])


}

pgls_res <- data.frame(gene = test_genes,p = p_vals)
pgls_sig <- pgls_res[pgls_res$p < 0.05,]
limma_sig <- limma_genes[limma_genes$adj.P.Val < 0.05,]



plot(euler(list(limma_sig=limma_sig$X,
                pgls_sig=pgls_sig$gene)),quantities = TRUE, labels = c("",""))

#write.table(pgls_res,"C:/Users/jmcgirr/Documents/GitHub/RNAseq_17killifish_osmotic/DE/PGLS/results/salinity_physiology_interaction.txt",sep="\t",quote=FALSE, row.names = FALSE)

```


